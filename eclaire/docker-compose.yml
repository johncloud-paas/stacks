services:
  # Backend API
  backend:
    image: ghcr.io/eclaire-labs/eclaire-backend:${BACKEND_TAG:-0.5}
    # For locally-built images, use: docker compose -f docker-compose.yml -f docker-compose.local.yml up
    # (docker-compose.local.yml is auto-generated by scripts/build.sh)
    # container_name: eclaire-backend
    # ports:
    #   - "3001:3001"
    environment:
      - LOG_LEVEL=info
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - REDIS_URL=redis://$COMPOSE_PROJECT_NAME-eclaire-redis-1:6379
      - DATABASE_URL=postgresql://eclaire:eclaire@$COMPOSE_PROJECT_NAME-eclaire-postgres-1:5432/eclaire
      - FRONTEND_URL=https://$HOST
      - USERS_DIR=/app/data/users
      - DATA_DIR=/app/data
      - LOGS_DIR=/app/data/logs
      - CONFIG_DIR=/app/config
      - AI_LOCAL_PROVIDER_URL=$AI_LOCAL_PROVIDER_URL
      - AI_PROXY_PROVIDER_URL=$AI_PROXY_PROVIDER_URL
      - AI_PROXY_API_KEY=$AI_PROXY_API_KEY
      - AI_PROMPT_LOGGING_ENABLED=$AI_PROMPT_LOGGING_ENABLED
      - BETTER_AUTH_SECRET=$BETTER_AUTH_SECRET
      - MASTER_ENCRYPTION_KEY=$MASTER_ENCRYPTION_KEY
      - API_KEY_HMAC_VERSION=$API_KEY_HMAC_VERSION
      - API_KEY_HMAC_KEY_V1=$API_KEY_HMAC_KEY_V1
    volumes:
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/data:/app/data
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/config:/app/config
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/logs:/app/data/logs
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"
    # logging:
    #   driver: json-file
    #   options:
    #     max-size: "5m"
    #     max-file: "2"
    restart: unless-stopped
    # Healthcheck inherited from Dockerfile (curl-based)

  # Frontend (Next.js)
  frontend:
    image: ghcr.io/eclaire-labs/eclaire-frontend:${FRONTEND_TAG:-0.5}
    # container_name: eclaire-frontend
    # ports:
    #   - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - LOG_LEVEL=info
      - BACKEND_URL=http://$COMPOSE_PROJECT_NAME-eclaire-backend-1:3001
      - BACKEND_INTERNAL_URL=http://$COMPOSE_PROJECT_NAME-eclaire-backend-1:3001
      - NEXT_TELEMETRY_DISABLED=1
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/logs:/app/data/logs
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"
    # logging:
    #   driver: json-file
    #   options:
    #     max-size: "5m"
    #     max-file: "2"
    restart: unless-stopped
    # Healthcheck inherited from Dockerfile (curl-based)
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.rule=Host(`$HOST`)"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.entrypoints=websecure"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.tls.certresolver=letsencrypt"
      - "traefik.http.services.$COMPOSE_PROJECT_NAME.loadbalancer.server.port=3000"
      - "homepage.group=$HOME_GROUP"
      - "homepage.name=$HOME_NAME"
      - "homepage.icon=$HOME_ICON"
      - "homepage.href=https://$HOST"
      - "homepage.description=$HOME_DESCRIPTION"

  # Workers (BullMQ)
  workers:
    image: ghcr.io/eclaire-labs/eclaire-workers:${WORKERS_TAG:-0.5}
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://$COMPOSE_PROJECT_NAME-eclaire-redis-1:6379
      - BACKEND_URL=http://$COMPOSE_PROJECT_NAME-eclaire-backend-1:3001
      - LOG_LEVEL=info
      - WORKER_PORT=3002
      - WORKER_CONCURRENCY=$WORKER_CONCURRENCY
      - AI_TIMEOUT=$AI_TIMEOUT
      - API_BASE_URL=http://$COMPOSE_PROJECT_NAME-eclaire-backend-1:3001
      - DOCLING_SERVER_URL=$DOCLING_SERVER_URL
      - DATA_DIR=/app/data
      - USERS_DIR=/app/data/users
      - LOGS_DIR=/app/data/logs
      - BROWSER_DATA_DIR=/app/data/browser-data
      - CONFIG_DIR=/app/config
      - WORKER_SHARED_DATA_PATH=/app/data/users
      - WORKER_API_KEY=$WORKER_API_KEY
      - AI_ASSISTANT_API_KEY=$AI_ASSISTANT_API_KEY
      - AI_LOCAL_PROVIDER_URL=$AI_LOCAL_PROVIDER_URL
      - AI_PROMPT_LOGGING_ENABLED=$AI_PROMPT_LOGGING_ENABLED
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/data:/app/data
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/data/browser-data:/app/browser-data
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/config:/app/config
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/logs:/app/data/logs
    # logging:
    #   driver: json-file
    #   options:
    #     max-size: "5m"
    #     max-file: "2"
    restart: unless-stopped
    # Healthcheck inherited from Dockerfile (curl-based)

  eclaire-postgres:
    image: 'postgres:16-alpine'
    restart: unless-stopped
    # healthcheck:
    #   test:
    #     - CMD-SHELL
    #     - 'pg_isready -d eclaire -U eclaire'
    #   interval: 2s
    #   timeout: 10s
    #   retries: 15
    volumes:
      - '$JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/db:/var/lib/postgresql/data'
    environment:
      POSTGRES_PASSWORD: eclaire
      POSTGRES_USER: eclaire
      POSTGRES_DB: eclaire
      SERVICE_PASSWORD_POSTGRESQL: '${SERVICE_PASSWORD_POSTGRESQL}'
      SERVICE_USER_POSTGRESQL: '${SERVICE_USER_POSTGRESQL}'
      
  eclaire-redis:
    image: 'redis:alpine'
    command: '--save 60 1 --loglevel warning'
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - 'redis-cli ping | grep PONG'
      interval: 2s
      timeout: 10s
      retries: 15
    volumes:
      - '$JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/redis:/data'

networks:
  default:
    external: true
    name: $TRAEFIK_NETWORK
    