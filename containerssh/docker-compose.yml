services:
  containerssh:
    image: containerssh/containerssh:latest
    restart: unless-stopped
    volumes:
      - $JOHNCLOUD_ROOT/${COMPOSE_PROJECT_NAME}/config.yaml:/etc/containerssh/config.yaml:ro
      - $JOHNCLOUD_ROOT/${COMPOSE_PROJECT_NAME}/ssh_host_keys:/etc/containerssh/keys
    # Expose SSH internally (Traefik forwards to this)
    expose:
      - "2222"
    # Traefik labels: Enable + route HTTP for OIDC callback + TCP for SSH
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      
      # HTTP router for OIDC callback (HTTPS)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.rule=Host(`$HOST`) && PathPrefix(`/oauth2`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.tls.certresolver=letsencrypt"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.service=${COMPOSE_PROJECT_NAME}-http-svc"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-http-svc.loadbalancer.server.port=2222"
      
      # Optional: HTTP redirect for /.well-known (if needed for OIDC discovery)
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-wellknown.rule=Host(`$HOST`) && PathPrefix(`/`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-wellknown.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-wellknown.tls.certresolver=letsencrypt"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-wellknown.service=${COMPOSE_PROJECT_NAME}-http-svc"
      
      # TCP router for SSH (forwards host:22 to container:2222)
      - "traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-tcp.rule=HostSNI(`$HOST`)"
      - "traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-tcp.entrypoints=ssh"
      - "traefik.tcp.routers.${COMPOSE_PROJECT_NAME}-tcp.service=${COMPOSE_PROJECT_NAME}-tcp-svc"
      - "traefik.tcp.services.${COMPOSE_PROJECT_NAME}-tcp-svc.loadbalancer.server.port=2222"

networks:
  default:
    external: true
    name: $TRAEFIK_NETWORK
    