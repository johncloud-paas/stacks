version: '3.1'

services:
  app:
    image: bitnami/wordpress:latest
    environment:
      TZ: $TZ
      APACHE_HTTP_PORT_NUMBER: 8080
      WORDPRESS_ENABLE_REVERSE_PROXY: yes
      WORDPRESS_USERNAME: $WORDPRESS_USERNAME
      WORDPRESS_PASSWORD: $WORDPRESS_PASSWORD
      WORDPRESS_EMAIL: $WORDPRESS_EMAIL
      WORDPRESS_RESET_DATA_PERMISSIONS: yes
      WORDPRESS_DATABASE_HOST: $COMPOSE_PROJECT_NAME-db-1
      WORDPRESS_DATABASE_PORT_NUMBER: 3306
      WORDPRESS_DATABASE_NAME: $DB_NAME
      WORDPRESS_DATABASE_USER: $DB_USER
      WORDPRESS_DATABASE_PASSWORD: $DB_PASSWORD
    volumes:
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/data:/bitnami/wordpress
    depends_on:
      - db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.rule=Host(`$HOST`)"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.entrypoints=websecure"
      - "traefik.http.routers.$COMPOSE_PROJECT_NAME.tls.certresolver=letsencrypt"
      - "traefik.http.services.$COMPOSE_PROJECT_NAME.loadbalancer.server.port=8080"

  db:
    image: bitnami/mariadb:latest
    environment:
      TZ: $TZ
      MARIADB_ROOT_USER: $DB_ROOT_USER
      MARIADB_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      MARIADB_DATABASE: $DB_NAME
      MARIADB_USER: $DB_USER
      MARIADB_PASSWORD: $DB_PASSWORD
      DB_SKIP_TEST_DB: $DB_SKIP_TEST_DB
    volumes:
      - $JOHNCLOUD_ROOT/$COMPOSE_PROJECT_NAME/db:/bitnami/mariadb
    labels:
      - "traefik.enable=false"

networks:
  default:
    external: true
    name: $TRAEFIK_NETWORK
    
